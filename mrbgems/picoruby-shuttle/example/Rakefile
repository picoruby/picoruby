require 'json'
require 'fileutils' # <- 追加
# require 'yaml' # YAMLライブラリは使用しない

namespace :shuttle do
  desc "Run server"
  task :server do
    puts "Starting server..."
    FileUtils.cd(File.expand_path('dist', __dir__)) do
      system("ruby -r un -e httpd . -p 8000")
    end
  end

  desc "Generate index.json from articles"
  task :generate_index do
    articles_dir = File.expand_path('articles', __dir__)
    dist_articles_dir = File.expand_path('dist/articles', __dir__)

    FileUtils.mkdir_p(dist_articles_dir)

    articles = []
    Dir.glob(File.join(articles_dir, "*.md")).each do |md_file_path|
      original_content = File.read(md_file_path)

      # Manually parse front matter
      front_matter = {}
      content_without_fm = original_content
      if original_content =~ /\A---\s*\n(?<fm>.*?)\n^---\s*$\n?/m
        # Extract front matter block
        fm_block = Regexp.last_match[:fm]
        fm_block.each_line do |line|
          if line =~ /^\s*(\w+):\s*(.*)\s*$/
            key = $1.strip
            value = $2.strip
            front_matter[key] = value
          end
        end
        # Update content_without_fm by removing front matter
        content_without_fm = original_content.sub(/\A---\s*\n(?<fm>.*?)\n^---\s*$\n?/m, '')
      end

      article_id = File.basename(md_file_path, ".md")

      articles << {
        id: article_id,
        title: front_matter['title'] || 'Untitled',
        date: front_matter['date'] || Time.now.strftime('%Y-%m-%d')
      }
    end

    # Sort articles by date (newest first)
    articles.sort_by! { |a| a[:date] }.reverse!

    # For now, we only generate page 1
    index_data = {
      page: 1,
      articles: articles
    }

    index_file = File.join(dist_articles_dir, "index_1.json")
    File.write(index_file, JSON.pretty_generate(index_data))

    puts "Generated #{index_file}"

    # Also copy original markdown files to dist
    Dir.glob(File.join(articles_dir, "*.md")).each do |md_file_path|
      dest_file = File.join(dist_articles_dir, File.basename(md_file_path))
      File.open(dest_file, "w") do |f|
        f.write(File.read(md_file_path))
      end
      puts "Copied #{md_file_path} to #{dest_file}"
    end
  end

  desc "Generate static pages from misc directory"
  task :generate_pages do
    misc_dir = File.expand_path('misc', __dir__)
    dist_dir = File.expand_path('dist', __dir__)
    template_file = File.expand_path('dist/index.html', __dir__)

    unless File.exist?(template_file)
      puts "Warning: Template file #{template_file} not found. Skipping page generation."
      next
    end

    template = File.read(template_file)

    Dir.glob(File.join(misc_dir, "*.md")).each do |md_file_path|
      page_name = File.basename(md_file_path, ".md")
      page_dir = File.join(dist_dir, page_name)
      FileUtils.mkdir_p(page_dir)

      # Read markdown file
      content = File.read(md_file_path)

      # Parse front matter
      front_matter = {}
      if content =~ /\A---\s*\n(?<fm>.*?)\n^---\s*$\n?/m
        fm_block = Regexp.last_match[:fm]
        fm_block.each_line do |line|
          if line =~ /^\s*(\w+):\s*(.*)\s*$/
            key = $1.strip
            value = $2.strip
            front_matter[key] = value
          end
        end
        content = content.sub(/\A---\s*\n(?<fm>.*?)\n^---\s*$\n?/m, '')
      end

      title = front_matter['title'] || page_name.gsub('_', ' ').capitalize

      # Copy markdown to dist/misc for SPA access
      misc_dist_dir = File.join(dist_dir, 'misc')
      FileUtils.mkdir_p(misc_dist_dir)
      File.write(File.join(misc_dist_dir, File.basename(md_file_path)), File.read(md_file_path))

      # Create page HTML with embedded Ruby script
      page_html = template.dup
      page_html.sub!(/<title>.*?<\/title>/, "<title>#{title} - PicoRuby Shuttle Blog</title>")

      # Replace the Ruby script to render the specific page
      page_html.sub!(/<script type="text\/ruby">.*?<\/script>/m, <<~RUBY)
        <script type="text/ruby">
          require 'shuttle'
          shuttle = Shuttle.new
          shuttle.render_static_page('misc/#{File.basename(md_file_path)}')
        </script>
      RUBY

      # Write the page HTML
      File.write(File.join(page_dir, 'index.html'), page_html)
      puts "Generated #{page_dir}/index.html"
    end
  end

  desc "Build CSS with Tailwind"
  task :build_css do
    puts "Building CSS with Tailwind..."
    system("npm run build:css")
  end

  desc "Build site for deployment"
  task :build do
    dist_dir = File.expand_path('dist', __dir__)
    FileUtils.mkdir_p(dist_dir)

    puts "Building Shuttle blog..."

    # Build CSS
    Rake::Task['shuttle:build_css'].invoke

    # Generate article index and copy markdown files
    Rake::Task['shuttle:generate_index'].invoke

    # Generate static pages
    Rake::Task['shuttle:generate_pages'].invoke

    puts "Build complete! Output in #{dist_dir}"
  end
end
