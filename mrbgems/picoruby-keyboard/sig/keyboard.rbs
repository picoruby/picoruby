# Layer switching functionality for keyboard matrix
class Keyboard
  include USB::HID::Keycode
  include LayerKeycode

  # Transparent key constant
  KC_NO: Integer

  type key_event_t = {
    row: Integer,
    col: Integer,
    keycode: Integer,
    modifier: Integer,
    pressed: bool
  }

  @row_count: Integer
  @col_count: Integer
  @layers: Hash[Symbol, Array[Integer]]
  @layer_names: Array[Symbol]
  @default_layer: Symbol | nil
  @locked_layer: Integer | nil
  @layer_stack: Array[Integer]
  @momentary_keys: Hash[[Integer, Integer], Integer]
  @tap_hold_keys: Hash[[Integer, Integer], Hash[Symbol, untyped]]
  @tap_threshold_ms: Integer
  @repush_threshold_ms: Integer
  @keys_pressed: Hash[[Integer, Integer], bool]
  @active_keys: Hash[[Integer, Integer], Hash[Symbol, Integer]]
  @matrix: KeyboardMatrix
  @callback: (^(key_event_t) -> void) | nil

  # Initialize keyboard layer manager
  def self.new: (Array[Integer] row_pins, Array[Integer] col_pins, ?debounce_ms: Integer) -> Keyboard
  # Add a layer with name and keymap
  def add_layer: (Symbol name, Array[Integer] keymap) -> void
  # Set default layer
  def default_layer=: (Symbol name) -> void
  # Set tap threshold in milliseconds
  def tap_threshold_ms=: (Integer value) -> Integer
  # Set repush threshold in milliseconds
  def repush_threshold_ms=: (Integer value) -> Integer
  # Start scanning loop
  def start: () { (key_event_t) -> void } -> void

  # Handle key event from KeyboardMatrix
  private def handle_event: (Hash[Symbol, untyped] event) -> void
  # Check if keycode is a modifier key
  private def is_modifier_key?: (Integer keycode) -> bool
  # Resolve keycode and modifier from layer stack
  private def resolve_key: (Integer row, Integer col) -> [Integer, Integer]
  # Resolve keycode from layer stack
  private def resolve_keycode: (Integer row, Integer col) -> Integer
  # Handle momentary layer key press/release
  private def handle_mo_key: (Integer row, Integer col, Integer layer_index, bool pressed) -> void
  # Handle toggle layer key press
  private def handle_tg_key: (Integer layer_index, bool pressed) -> void
  # Handle MT tap/hold key press/release
  private def handle_mt_key: (Integer row, Integer col, Integer modifier_index, Integer tap_keycode, bool pressed) -> void
  # Handle LT tap/hold key press/release
  private def handle_lt_key: (Integer row, Integer col, Integer layer_index, Integer tap_keycode, bool pressed) -> void
  # Update tap/hold key states
  private def update_tap_hold_keys: () -> void
  # Mark that another key was pressed
  private def mark_other_key_pressed: () -> void
  # Activate a momentary layer
  private def activate_layer: ([Integer, Integer] key_pos, Integer layer_index) -> void
  # Deactivate a momentary layer
  private def deactivate_layer: ([Integer, Integer] key_pos, Integer layer_index) -> void
  # Activate a modifier
  private def activate_modifier: ([Integer, Integer] key_pos, Integer modifier_index) -> void
  # Deactivate a modifier
  private def deactivate_modifier: ([Integer, Integer] key_pos) -> void
end
