<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="../test.css">
  </head>
  <body>
    <div><a href="../index.html">Back</a></div>
    <h1>PicoRuby WASM: Exception Handling Test Suite</h1>

    <div class="instructions">
      <h2>How to Run Tests</h2>
      <ol>
        <li>Build picoruby.wasm:
          <pre>cd lib/picoruby/mrbgems/picoruby-wasm && rake</pre>
        </li>
        <li>Start HTTP server:
          <pre>cd demo && python3 -m http.server 8080</pre>
        </li>
        <li>Open <a href="http://localhost:8080/www/">http://localhost:8080/www/</a> in your browser</li>
        <li>Click on each test link below and click the "Run Test" button</li>
        <li>Compare the output with the expected result shown in each test page</li>
      </ol>
    </div>

    <h2>Test Cases</h2>

    <ul class="test-list">
      <li class="test-item">
        <h3><span class="status basic">BASIC</span> <a href="raise_rescue.html">1. Basic Async Exception</a></h3>
        <p><strong>Purpose:</strong> Verify basic exception handling in asynchronous context</p>
        <p><strong>Tests:</strong> Simple raise and rescue inside fetch() callback</p>
      </li>

      <li class="test-item">
        <h3><span class="status intermediate">INTERMEDIATE</span> <a href="nested_async.html">2. Nested Async Exceptions</a></h3>
        <p><strong>Purpose:</strong> Verify exception propagation through 3 levels of nested async calls</p>
        <p><strong>Tests:</strong> Exception thrown at deepest level should be caught at outermost rescue clause</p>
      </li>

      <li class="test-item">
        <h3><span class="status intermediate">INTERMEDIATE</span> <a href="multi_task.html">3. Multi-Task Independence</a></h3>
        <p><strong>Purpose:</strong> Verify that exceptions in different tasks don't interfere with each other</p>
        <p><strong>Tests:</strong> 3 parallel tasks with independent exception handling</p>
      </li>

      <li class="test-item">
        <h3><span class="status intermediate">INTERMEDIATE</span> <a href="ensure.html">4. Ensure Clause Execution</a></h3>
        <p><strong>Purpose:</strong> Verify that ensure clauses execute even after exceptions in async context</p>
        <p><strong>Tests:</strong> begin-rescue-ensure structure after async boundary</p>
      </li>

      <li class="test-item">
        <h3><span class="status intermediate">INTERMEDIATE</span> <a href="reraise.html">5. Exception Re-raising</a></h3>
        <p><strong>Purpose:</strong> Verify that exceptions can be re-raised from rescue clauses</p>
        <p><strong>Tests:</strong> Nested method calls with intermediate rescue and re-raise</p>
      </li>

      <li class="test-item">
        <h3><span class="status advanced">ADVANCED</span> <a href="deep_recursion.html">6. Deep Recursion + Async</a></h3>
        <p><strong>Purpose:</strong> Verify exception handling with deep call stacks in async context</p>
        <p><strong>Tests:</strong> 10-level recursive calls after async boundary</p>
      </li>

      <li class="test-item">
        <h3><span class="status advanced">ADVANCED</span> <a href="custom_exception.html">7. Custom Exception Classes</a></h3>
        <p><strong>Purpose:</strong> Verify that custom exception classes are preserved across async boundaries</p>
        <p><strong>Tests:</strong> CustomError class with attributes, type-based rescue</p>
      </li>

      <li class="test-item">
        <h3><span class="status advanced">ADVANCED</span> <a href="promise_chain.html">8. Promise Chain Exceptions</a></h3>
        <p><strong>Purpose:</strong> Verify exception handling in chained Promise callbacks</p>
        <p><strong>Tests:</strong> Exception in nested fetch callbacks with outer rescue</p>
      </li>

      <li class="test-item">
        <h3><span class="status advanced">STRESS</span> <a href="stress.html">9. Stress Test (100 Parallel Tasks)</a></h3>
        <p><strong>Purpose:</strong> Verify system stability with large number of concurrent tasks</p>
        <p><strong>Tests:</strong> 100 parallel fetch operations, 33 with exceptions, 67 successful</p>
      </li>
    </ul>

    <h2>Understanding the Results</h2>

    <p>Each test page shows the expected output in an HTML comment. After clicking "Run Test":</p>
    <ul>
      <li><strong>PASS:</strong> Output matches expected result exactly</li>
      <li><strong>FAIL:</strong> Output differs from expected result</li>
      <li><strong>ERROR:</strong> Browser console shows errors (open Developer Tools to check)</li>
    </ul>

    <h2>What These Tests Verify</h2>

    <p>This test suite validates that PicoRuby WASM's task-based architecture correctly handles exceptions
    across asynchronous boundaries <strong>without ASYNCIFY=1</strong>. The tests verify:</p>

    <ul>
      <li>setjmp/longjmp works correctly when task is resumed after async operation</li>
      <li>Each task maintains independent exception context</li>
      <li>Exception propagation through nested async calls</li>
      <li>Resource cleanup via ensure clauses</li>
      <li>Custom exception class preservation</li>
      <li>System stability under load</li>
    </ul>

    <h2>Technical Background</h2>

    <p>PicoRuby WASM uses a task-based cooperative multitasking system that carefully manages
    the boundary between synchronous C code and asynchronous JavaScript Promises:</p>

    <pre>Ruby Code (fetch callback)
  |
  v
mrb_suspend_task()        # Exit setjmp scope
  |
  v
JavaScript Promise.then()  # Async boundary (no setjmp)
  |
  v
resume_promise_task()     # C callback
  |
  v
mrb_resume_task()
  |
  v
mrb_vm_exec()            # NEW setjmp scope established
  |
  v
Ruby Code execution       # longjmp works within same C stack</pre>

    <p>This design ensures that longjmp never attempts to cross async boundaries, avoiding the need
    for Emscripten's ASYNCIFY feature which would increase WASM size by 50%+.</p>

    <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; color: #666; font-size: 0.9em;">
      <p><a href="index.html">Back to Demo Index</a></p>
    </div>
  </body>
</html>
