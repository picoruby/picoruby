<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="../test.css">
  </head>
  <body>
    <div><a href="index.html">Back</a></div>
    <h1>Stress Test: 100 Parallel Tasks</h1>
    <button id="test">Run Test</button>
    <pre id="output"></pre>

    <!-- Expected Result:
Starting stress test with 100 parallel tasks...
All 100 tasks launched
(Then 100 lines of "Task N: Success" or "Task N: Error caught")
(33 tasks with errors, 67 tasks with success)
    -->

    <script type="text/ruby">
      require 'js'

      def log(msg)
        output = JS.document.getElementById('output')
        current = output.innerText.to_s
        output.innerText = current + msg + "\n"
      end

      JS.document.getElementById('test').addEventListener('click') do
        log "Starting stress test with 100 parallel tasks..."

        success_count = 0
        error_count = 0

        100.times do |i|
          JS.global.fetch('../favicon.ico') do
            if i % 3 == 0
              raise "Error in task #{i}"
            end
            success_count += 1
            log "Task #{i}: Success (total: #{success_count})"
          rescue => e
            error_count += 1
            log "Task #{i}: Error caught (total: #{error_count})"
          end
        end

        log "All 100 tasks launched"
      end
    </script>
    <script src="../init.iife.js"></script>
  </body>
</html>
