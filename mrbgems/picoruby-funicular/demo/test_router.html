<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Funicular Router Test</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    nav { margin-bottom: 20px; padding: 10px; background: #f0f0f0; border-radius: 5px; }
    nav a { margin-right: 15px; text-decoration: none; color: #007bff; cursor: pointer; }
    nav a:hover { text-decoration: underline; }
    #app { padding: 20px; border: 2px solid #007bff; border-radius: 5px; min-height: 200px; }
    .page-title { color: #333; margin-bottom: 15px; }
    button { padding: 8px 16px; margin: 5px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; }
    button:hover { background: #0056b3; }
    .status { margin-top: 10px; padding: 10px; background: #e7f3ff; border-radius: 4px; }
    .info { margin-bottom: 10px; padding: 10px; background: #fff3cd; border-radius: 4px; font-size: 14px; }
  </style>
</head>
<body>
  <div><a href="../index.html">Back</a></div>
  <h1>Funicular Router Test</h1>

  <div class="info">
    This demo uses pathname-based routing (History API).
    Navigation links use <code>Funicular.router.navigate()</code>.
  </div>

  <nav id="nav"></nav>

  <div id="app"></div>

  <script type="text/ruby">
    # Navigation component (shared across all pages)
    class NavComponent < Funicular::Component
      def go_to(path)
        ->(event) {
          event.preventDefault
          Funicular.router.navigate(path)
        }
      end

      def render
        nav do
          a(href: '/login', onclick: go_to('/login')) { 'Login' }
          a(href: '/home', onclick: go_to('/home')) { 'Home' }
          a(href: '/settings', onclick: go_to('/settings')) { 'Settings' }
          a(href: '/users', onclick: go_to('/users')) { 'Users' }
        end
      end
    end

    class LoginComponent < Funicular::Component
      def initialize_state
        { username: '' }
      end

      def on_username_input(event)
        patch(username: event.target[:value].to_s)
      end

      def on_login_click(event)
        event.preventDefault
        Funicular.router.navigate('/home')
      end

      def render
        div(class: 'login-page') do
          h2(class: 'page-title') { 'Login Page' }

          div do
            input(
              type: 'text',
              placeholder: 'Username',
              value: state.username,
              oninput: :on_username_input
            )
          end

          div do
            button(onclick: :on_login_click) { 'Login' }
          end

          div(class: 'status') do
            "Username: #{state.username}"
          end
        end
      end
    end

    class HomeComponent < Funicular::Component
      def initialize_state
        { count: 0 }
      end

      def increment(event)
        event.preventDefault
        patch(count: state.count + 1)
      end

      def go_to_settings(event)
        event.preventDefault
        Funicular.router.navigate('/settings')
      end

      def render
        div(class: 'home-page') do
          h2(class: 'page-title') { 'Home Page' }

          div do
            "Counter: #{state.count}"
          end

          div do
            button(onclick: :increment) { 'Increment' }
            button(onclick: :go_to_settings) { 'Go to Settings' }
          end

          div(class: 'status') do
            "You are on the home page. Click around to test routing!"
          end
        end
      end
    end

    class SettingsComponent < Funicular::Component
      def initialize_state
        { theme: 'light', notifications: true }
      end

      def toggle_theme(event)
        event.preventDefault
        new_theme = state.theme == 'light' ? 'dark' : 'light'
        patch(theme: new_theme)
      end

      def toggle_notifications(event)
        event.preventDefault
        patch(notifications: !state.notifications)
      end

      def go_to_home(event)
        event.preventDefault
        Funicular.router.navigate('/home')
      end

      def render
        div(class: 'settings-page') do
          h2(class: 'page-title') { 'Settings Page' }

          div do
            span { "Theme: #{state.theme}" }
            button(onclick: :toggle_theme) { 'Toggle Theme' }
          end

          div do
            span { "Notifications: #{state.notifications ? 'ON' : 'OFF'}" }
            button(onclick: :toggle_notifications) { 'Toggle Notifications' }
          end

          div do
            button(onclick: :go_to_home) { 'Back to Home' }
          end

          div(class: 'status') do
            "Configure your settings here"
          end
        end
      end
    end

    # Demonstrates dynamic route with :id parameter
    class UsersComponent < Funicular::Component
      def initialize_state
        { users: [
          { id: 1, name: 'Alice' },
          { id: 2, name: 'Bob' },
          { id: 3, name: 'Charlie' }
        ]}
      end

      def go_to_user(id)
        ->(event) {
          event.preventDefault
          Funicular.router.navigate("/users/#{id}")
        }
      end

      def render
        div(class: 'users-page') do
          h2(class: 'page-title') { 'Users List' }

          ul do
            state.users.each do |user|
              li do
                a(href: "/users/#{user[:id]}", onclick: go_to_user(user[:id])) do
                  user[:name]
                end
              end
            end
          end

          div(class: 'status') do
            "Click a user to see dynamic route with :id parameter"
          end
        end
      end
    end

    class UserDetailComponent < Funicular::Component
      def initialize(params = {})
        super(params)
        @user_id = params[:id]
      end

      def initialize_state
        { user_id: @user_id }
      end

      def go_back(event)
        event.preventDefault
        Funicular.router.navigate('/users')
      end

      def render
        div(class: 'user-detail-page') do
          h2(class: 'page-title') { "User Detail" }

          div do
            "Viewing user ID: #{state.user_id}"
          end

          div do
            button(onclick: :go_back) { 'Back to Users' }
          end

          div(class: 'status') do
            "This page demonstrates dynamic routing with params[:id] = #{state.user_id}"
          end
        end
      end
    end

    # Start router with Rails-style DSL
    puts "Starting Funicular Router..."
    Funicular.start(container: 'app') do |router|
      # Rails-style route definitions with named routes
      router.get '/login',      to: LoginComponent,      as: :login
      router.get '/home',       to: HomeComponent,       as: :home
      router.get '/settings',   to: SettingsComponent,   as: :settings
      router.get '/users',      to: UsersComponent,      as: :users
      router.get '/users/:id',  to: UserDetailComponent, as: :user

      router.set_default('/login')
    end
    puts "Router started!"

    # Mount navigation component separately
    NavComponent.new.mount(JS.global.document.getElementById('nav'))
  </script>
  <script src="../init.iife.js"></script>
</body>
</html>
